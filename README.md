# BoardGame Analyzer

BoardGameGeek (BGG) APIを使用してボードゲーム情報を検索、分析、保存するためのStreamlitアプリケーションです。

**デモ:** [Streamlit Community Cloud](https://boardgameanalyzer-gsmlbaspmgvf3arxttip4f.streamlit.app/)（一部文字化けがございます）

## 目次

- [BoardGame Analyzer](#boardgame-analyzer)
  - [目次](#目次)
  - [主な機能](#主な機能)
  - [インストール方法](#インストール方法)
  - [アプリの使い方](#アプリの使い方)
    - [基本機能](#基本機能)
      - [ゲーム名で検索](#ゲーム名で検索)
      - [ゲームIDで詳細情報を取得](#ゲームidで詳細情報を取得)
      - [YAMLでデータを保存](#yamlでデータを保存)
      - [ゲーム比較機能](#ゲーム比較機能)
    - [類似性検索機能](#類似性検索機能)
  - [自動更新とデータ同期](#自動更新とデータ同期)
    - [日次更新スクリプト (daily\_update.py)](#日次更新スクリプト-daily_updatepy)
    - [リモートデータ同期スクリプト (fetch\_boardgame\_data.py)](#リモートデータ同期スクリプト-fetch_boardgame_datapy)
  - [埋め込みデータファイル (game\_embeddings.pkl)](#埋め込みデータファイル-game_embeddingspkl)
    - [作成、入手方法](#作成入手方法)
    - [使用方法](#使用方法)
    - [注意点](#注意点)
  - [技術的詳細](#技術的詳細)
    - [学習曲線分析システム](#学習曲線分析システム)
      - [分析に使用する要素](#分析に使用する要素)
      - [分析結果の指標](#分析結果の指標)
    - [複雑さデータのカスタマイズ](#複雑さデータのカスタマイズ)
      - [編集時の注意点](#編集時の注意点)
    - [戦略的価値と相互作用の分析](#戦略的価値と相互作用の分析)
    - [埋め込みモデルと類似性検索の技術](#埋め込みモデルと類似性検索の技術)
      - [埋め込みモデルの生成技術](#埋め込みモデルの生成技術)
      - [類似度計算アルゴリズム](#類似度計算アルゴリズム)
      - [ファイルの技術的構造](#ファイルの技術的構造)
      - [類似性理由分析アルゴリズム](#類似性理由分析アルゴリズム)
  - [プロジェクト構成](#プロジェクト構成)
  - [注意事項](#注意事項)
  - [謝辞](#謝辞)

## 主な機能

- **検索と情報取得**
  - ゲーム名での検索: 名前を使ってBGGからボードゲームを検索
  - ゲームIDによる詳細情報取得: ゲームIDを使用して詳細なゲーム情報を取得
  - 保存済みゲームの選択: 保存したゲームデータをドロップダウンから簡単に選択

- **データ分析と保存**
  - データ分析: ゲームの複雑さ、学習曲線、リプレイ性などを自動分析
  - YAMLデータ保存: 取得したゲーム情報をYAML形式でローカルに保存
  - データ比較機能: 既存データと新規取得データの自動比較

- **ゲーム特性分析**
  - ラーニングカーブ分析: ゲームの学習しやすさやマスターに必要な時間の推定
  - カテゴリ分析: ゲームカテゴリに基づく複雑さの評価
  - ランキング分析: BGGランキング種別と順位に基づく評価
  - 戦略深度評価: 意思決定の質と重みに基づく戦略性の分析
  - プレイヤー相互作用分析: ゲームにおけるプレイヤー間の相互作用の評価

- **比較と類似性分析**
  - ゲーム比較機能: 複数のゲームを選択し、レーダーチャートと数値比較で分析
  - 類似性検索機能: 埋め込みデータを使用して類似ゲームを検索・分析

- **データ管理と自動化**
  - 日次データ更新: 毎日のゲームデータ自動更新とバックアップ
  - リモートデータ取得: Raspberry Piなどのリモートサーバーからデータを同期

## インストール方法

1. このリポジトリをクローンまたはダウンロードします

```bash
git clone https://github.com/yourusername/boardgame-analyzer.git
cd boardgame-analyzer
```

2. 必要なライブラリをインストールします

```bash
pip install -r requirements.txt
```

または個別にインストールする場合:

```bash
pip install streamlit pandas requests pyyaml deepdiff plotly matplotlib seaborn scikit-learn tqdm python-dotenv
```

類似性検索機能を使用する場合は、追加で以下のライブラリが必要です:

```bash
pip install voyageai paramiko
```

3. アプリケーションを実行します

```bash
streamlit run app.py
```

ブラウザで自動的に開かれるアプリケーションにアクセスします（通常は <http://localhost:8501>）

## アプリの使い方

### 基本機能

#### ゲーム名で検索
1. サイドバーから「ゲーム名で検索」を選択
2. 検索したいゲーム名を入力
3. 完全一致検索を行いたい場合はチェックボックスをオン
4. 「検索」ボタンをクリック

#### ゲームIDで詳細情報を取得
1. サイドバーから「ゲームIDで詳細情報を取得」を選択
2. 手動入力または保存済みYAMLファイルから選択
3. 「詳細情報を取得」ボタンをクリック
4. 詳細情報が表示され、以下の情報を確認できます：
   - 基本情報（ゲーム名、発行年、平均評価）
   - プレイ人数情報（最適人数、対応人数）
   - 推奨年齢・プレイ時間
   - ゲームの複雑さと学習曲線分析
   - ゲーム説明文
   - メカニクス、カテゴリ、ランキング、デザイナー、パブリッシャー情報

#### YAMLでデータを保存
1. サイドバーから「YAMLでデータを保存」を選択
2. 保存したいゲームをドロップダウンリストから選択
3. ファイル名を入力（空白の場合は自動生成）
4. 「選択したゲームデータをYAMLに保存」ボタンをクリック

#### ゲーム比較機能
1. サイドバーから「ゲーム比較」を選択
2. 比較したいゲームを複数選択（最大6つまで）
3. 選択したゲームの特性がレーダーチャートで視覚化され、数値比較テーブルで詳細な数値を確認できます

### 類似性検索機能

1. サイドバーから「類似性検索」を選択
2. 検索の設定を調整（表示する類似ゲーム数、類似度閾値）
3. カテゴリやメカニクスでフィルタリングするには「検索フィルターを設定」を展開
4. フィルタリング結果から検索の基準となるゲームを選択
5. 「類似ゲームを検索」ボタンをクリック
6. 結果は以下のタブで表示されます：
   - 類似ゲーム一覧：類似度スコアと類似の理由を含むゲーム情報
   - 類似度ヒートマップ：ゲーム間の類似関係を視覚化
   - データ分析：最も類似度が高いゲームのリスト、カテゴリとメカニクスの分布分析

## 自動更新とデータ同期
Raspberry PiなどのLinuxベースのリモートサーバーを用意することで常に最新のゲームデータで解析できます。2025/04時点ではRaspberry Pi Zero 2 Wを推奨します。

### 日次更新スクリプト (daily_update.py)

Raspberry Piなどのリモートサーバーでこのスクリプトを定期実行することで以下の機能を提供します：

- 保存済みのデータをYYMMDD形式でバックアップ
- 既存のゲームデータを自動的に更新（BGG APIから最新情報を取得）
- 設定ファイルの変更検出と記録

設定例（crontabを使用）：
```
0 1 * * * cd /path/to/boardgame-analyzer && python daily_update.py >> logs/daily_update.log 2>&1
```

### リモートデータ同期スクリプト (fetch_boardgame_data.py)

Raspberry Piなどのリモートサーバーで更新したBoardGame Analyzerのデータを取得するためのスクリプトです：

- SSH経由でゲームデータと設定ファイルを取得
- 接続設定のカスタマイズ（ホスト、ポート、認証方法）
- 既存ファイルの自動クリーンアップ

使用例：
```bash
python fetch_boardgame_data.py --host 192.168.50.192 --username pi
```

## 埋め込みデータファイル (game_embeddings.pkl)

`game_embeddings.pkl` は類似性検索機能を使用するために必要な埋め込みデータファイルです。

### 作成、入手方法

1. **配布されているファイルを使用する**：
   - アプリケーションのリポジトリから入手できます
   - このファイルを `boardgame-analyzer` ディレクトリのルートに配置することで、類似性検索機能がすぐに使用可能になります
   - 作者のボードゲームコレクションから作成した埋め込みデータですので、使用感の確認にお使いください

2. **ご自身で生成する**：
   - `generate_embedding_model.py` スクリプトを使用して自分で生成できます
   - Voyage AI の API を使用します
   - 必要条件：
     - Voyage AIのユーザー登録 (https://www.voyageai.com/)
     - Voyage AIのAPIトークン発行(取り扱いに注意ください)
     - API 利用のための支払い設定
     - `VOYAGE_API_KEY` の環境変数設定
   - 生成コマンド例：
     ```bash
     export VOYAGE_API_KEY="your_api_key_here"
     python generate_embedding_model.py --data_path "game_data/*.yaml" --output "game_embeddings.pkl"
     ```

### 使用方法

1. ファイルをアプリケーションのルートディレクトリに配置します
2. アプリケーションの「類似性検索」機能を選択します
3. デフォルトでは `game_embeddings.pkl` が読み込みますが、サイドバーの「エンベディングデータファイル」で別のファイルパスを指定できます

### 注意点

- このファイルがないと類似性検索機能は使用できません（他の機能は通常通り使用可能）
- ファイルサイズは保存されているゲーム数によって異なりますが、多数のゲームデータを含む場合は比較的大きくなる可能性があります
- 自分で生成する場合、API 呼び出しにコストがかかります（Voyage AI の料金体系に基づく）
- 定期的に更新することで、新しいゲームデータを類似性検索に含めることができます

独自の埋め込みデータを作成することで、特定のゲームジャンルや好みに特化した類似性検索が可能になります。

## 技術的詳細

### 学習曲線分析システム

このアプリは独自のアルゴリズムを使用してボードゲームの学習曲線を分析します：

#### 分析に使用する要素
- メカニクスの複雑さと数
- BGGでの重さ評価（Weight）
- カテゴリの複雑さ
- ランキング情報
- リプレイ性
- メカニクスの戦略的価値
- プレイヤー相互作用値
- プレイ時間

#### 分析結果の指標
- 初期学習の障壁（1〜5）
- 戦略の深さ（1〜5）
- 意思決定ポイント（1〜5）
- プレイヤー相互作用（1〜5）
- ルールの複雑さ（1〜5）
- カテゴリに基づく複雑さ（1〜5）
- ランキングに基づく複雑さ（1〜5）
- 学習曲線タイプ
- リプレイ性（1〜5）
- マスター時間
- 対象プレイヤータイプ

### 複雑さデータのカスタマイズ

本アプリは、以下の3つのYAMLファイルを使用して複雑さの評価を行います：

- `mechanics_data.yaml`: メカニクス（ゲームの仕組み）ごとの複雑さ、戦略的価値、相互作用値
- `categories_data.yaml`: カテゴリ（ゲームのテーマや種類）ごとの複雑さ、戦略的価値、相互作用値
- `rank_complexity.yaml`: ランキング種別ごとの複雑さ、戦略的価値、相互作用値

これらのファイルは手動で編集できるため、実際のゲーム体験に基づいてカスタマイズすることで、より正確な分析が可能になります。初回起動時に基本データが自動生成され、新しいメカニクスやカテゴリが見つかると自動的に追加されます。

#### 編集時の注意点

- すべてのYAMLファイルは必ず UTF-8 エンコーディングで保存してください
- 他のエンコーディング（Shift-JISなど）で保存すると読み込みエラーが発生します
- 数値は1.0～5.0の範囲内にしてください（小数点第一位まで）

### 戦略的価値と相互作用の分析

各メカニクスとカテゴリには以下の値が定義されています：

- 複雑さ (complexity): ルールや概念の複雑さ（1.0～5.0）
- 戦略的価値 (strategic_value): 戦略的深さへの貢献度（1.0～5.0）
- 相互作用値 (interaction_value): プレイヤー間の相互作用の程度（1.0～5.0）

例えば、mechanics_data.yamlでは以下のように定義されています：

```yaml
Engine Building:
  complexity: 4.7
  strategic_value: 5.0
  interaction_value: 2.0
  description: 戦略的に非常に深いが、相互作用は比較的少ない
```

これらの値は、ゲームの戦略深度と相互作用の複雑さをより精密に計算するために使用されます。

### 埋め込みモデルと類似性検索の技術

`game_embeddings.pkl`はアプリケーションの類似性検索機能の中核となるファイルです。

#### 埋め込みモデルの生成技術

- **ベクトル化プロセス**: 
  - 各ゲームのテキストデータ（名前、説明、カテゴリ、メカニクスなど）に意味を補足したテキストに変換
  - Voyage AI API（voyage-3-large モデル）を使用してテキストを1024次元のベクトル空間にエンコード
  - これらによりゲームの特徴や性質が数学的に表現される

- **技術的仕様**:
  - ベクトル次元数: 1024次元（voyage-3-large モデルによる）
  - エンベディングタイプ: 密ベクトル表現（dense vector representation）

#### 類似度計算アルゴリズム

- **コサイン類似度**:
  - 2つのベクトル間の角度のコサインを測定し、0〜1の類似度スコアを算出
  - 値が1に近いほど類似度が高く、0に近いほど類似度が低い
  - 数式: cos(θ) = (A・B) / (||A|| ||B||)
  
- **事前計算された類似度行列**:
  - すべてのゲーム間のペアワイズ類似度を事前計算
  - N×Nの行列（Nはゲーム数）を保存
  - これにより実行時の類似度計算を省略し、検索を高速化

#### ファイルの技術的構造

`game_embeddings.pkl`は以下の構造を持つPythonのpickleファイルです：

```python
{
    'games': [  # ゲーム情報のリスト
        {'id': '123456', 'name': 'Game Name', 'japanese_name': '日本語名', 'file': 'path/to/yaml'},
        # ... 他のゲーム情報
    ],
    'game_data_list': [  # ゲームの詳細データリスト
        {'name': 'Game Name', 'mechanics': [...], 'categories': [...], ...},
        # ... 他のゲームデータ
    ],
    'embeddings': numpy.ndarray,  # 形状: [N, 1024] - N個のゲームそれぞれに1024次元ベクトル
    'similarity_matrix': numpy.ndarray,  # 形状: [N, N] - すべてのゲーム間の類似度を格納
    'metadata': {  # ファイルの更新に関するメタデータ
        'file_path1': 'hash1',  # ファイルパスとそのハッシュ値
        # ... 他のファイルメタデータ
    }
}
```

#### 類似性理由分析アルゴリズム

類似性の理由を自動分析する機能も含まれており、以下の要素を比較します：

- 共通カテゴリ
- 共通メカニクス
- 戦略的深さの類似度
- 対象プレイヤータイプの共通性
- 複雑さスコアの近さ
- 発行年の近接性
- 説明文からの共通キーワード

これらの分析結果が「類似性の理由」として表示され、ゲーム間の関連性をより深く理解するのに役立ちます。

## プロジェクト構成

```
boardgame-analyzer/
├── app.py                         # メインアプリケーション
├── requirements.txt               # 必要なパッケージのリスト
├── generate_embedding_model.py    # 埋め込みモデル生成スクリプト
├── daily_update.py                # 毎日のデータ更新スクリプト
├── fetch_boardgame_data.py        # リモートデータ取得スクリプト
├── game_embeddings.pkl            # 埋め込みデータファイル（類似性検索用）
├── config/                        # 設定ファイル
│   ├── mechanics_data.yaml        # メカニクスの複雑さデータ
│   ├── categories_data.yaml       # カテゴリの複雑さデータ
│   └── rank_complexity.yaml       # ランキング種別の複雑さデータ
├── game_data/                     # 保存されたゲームデータ
├── backup/                        # バックアップデータ
├── logs/                          # ログファイル
│   └── daily_update.log           # 日次更新ログ
├── src/                           # ソースコード
│   ├── api/                       # API関連
│   │   ├── bgg_api.py             # BoardGameGeek API
│   │   └── rate_limiter.py        # レート制限とキャッシュ
│   ├── data/                      # データ処理
│   │   └── data_handler.py        # データ処理
│   └── analysis/                  # 分析関連
│       ├── similarity.py          # 類似性検索
│       ├── game_analyzer.py       # ゲーム分析
│       ├── learning_curve.py      # 学習曲線
│       ├── mechanic_complexity.py # メカニクス複雑さ
│       ├── category_complexity.py # カテゴリ複雑さ
│       ├── rank_complexity.py     # ランキング複雑さ
│       └── strategic_depth.py     # 戦略深度
└── ui/                            # UI関連
    ├── ui_components.py           # UIコンポーネント関数
    └── pages/                     # ページコンポーネント
        ├── search_page.py         # 検索ページ
        ├── details_page.py        # 詳細ページ
        ├── save_page.py           # 保存ページ
        └── compare_page.py        # 比較ページ
```

## 注意事項

- ゲーム名に特殊文字（:;など）が含まれていると、ファイル保存に失敗する場合があります
- このツールは学習曲線分析アルゴリズムに主観的要素を含み、絶対的な評価ではありません
- エンベディングの生成にはVoyage AIのAPIキーが必要で、使用量に応じた課金が発生します
- 日次更新スクリプトは、定期的な実行のためにcrontabなどのスケジューラーを設定する必要があります

## 謝辞

このアプリケーションはBoardGameGeek APIを使用しています。BoardGameGeekに感謝します。
また、類似性検索機能の埋め込みデータの作成にはVoyage AIのエンベディングAPIを使用しています。